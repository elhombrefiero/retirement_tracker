{% extends 'finances/master_template.html' %}

{% block header_extra %}
    <Title>{{object.name}} Overview</Title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
    <!-- Moment for the dates-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <!-- JQuery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
{% endblock %}

{% block mymessage %}
<nav class="level is-mobile">
  <div class="level-item has-text-centered">
    <div>
      <p class="heading">User</p>
      <p class="title"><a href="/finances/update_user/{{object.pk}}">{{object.name}}</a></p>
    </div>
  </div>
  <div class="level-item has-text-centered">
    <div>
      <p class="heading">Estimated Retirement Date</p>
      <p class="title">{{object.return_retirement_datetime}}</p>
    </div>
  </div>
  <div class="level-item has-text-centered">
    <div>
      <p class="heading">Current Net Worth</p>
      <p class="title">{{net_worth}}</p>
    </div>
  </div>
  <div class="level-item has-text-centered">
    <div>
      <p class="heading">Projected Net Worth at Retirement</p>
      <p class="title">{{projected_net_worth}}</p>
    </div>
  </div>
</nav>

<!--Buttons to add and update the user stuff-->
<nav class="navbar" role="navigation" aria-label="main navigation">
  <div class="dropdown is-hoverable">
    <div class="dropdown-trigger">
      <button class="button" aria-haspopup="true" aria-controls="dropdown-menu">
        <span>Add</span>
        <span class="icon is-small">
          <i class="fas fa-angle-down" aria-hidden="true"></i>
        </span>
      </button>
    </div>
    <div class="dropdown-menu" role="menu">
      <div class="dropdown-content">
        <div class="dropdown-item">
        <a href="/finances/user/{{object.pk}}/add_checking_account" class="dropdown-item">
          Checking Account
        </a>
        </div>
        <div class="dropdown-item">
        <a href="/finances/user/{{object.pk}}/add_debt_account" class="dropdown-item">
          Debt Account
        </a>
        </div>
        <div class="dropdown-item">
        <a href="/finances/user/{{object.pk}}/add_retirement_account" class="dropdown-item">
          Retirement Account
        </a>
        </div>
        <div class="dropdown-item">
        <a href="/finances/user/{{object.pk}}/add_retirement_account" class="dropdown-item">
          Trading Account
        </a>
        </div>
        <div class="dropdown-item">
        <a href="/finances/user/{{object.pk}}/add_income" class="dropdown-item">
          Income
        </a>
        </div>
        <div class="dropdown-item">
        <a href="/finances/user/{{object.pk}}/add_expense" class="dropdown-item">
          Expense
        </a>
        </div>
<!--        <div class="dropdown-item">-->
<!--          <a href="/finances/user/{{object.pk}}/transfer" class="dropdown-item">-->
<!--          Transfer-->
<!--        </a>-->
<!--        </div>-->
        <div class="dropdown-item">
        {% if month and year %}
        <a href="/finances/user/{{object.pk}}/{{month}}/{{year}}/add_monthly_budget" class="dropdown-item">
        {% else %}
        <a href="/finances/user/{{object.pk}}/add_monthly_budget" class="dropdown-item">
        {% endif %}
          Monthly Budget
        </a>
        </div>
        <div class="dropdown-item">
          <a href="/finances/user/{{object.pk}}/add_work_income" class="dropdown-item">
            Work Income
          </a>
        </div>
      </div>
    </div>
  </div>
  <div class="dropdown is-hoverable">
    <div class="dropdown-trigger">
      <button class="button" aria-haspopup="true" aria-controls="dropdown-menu">
        <span>View Existing Items</span>
        <span class="icon is-small">
          <i class="fas fa-angle-down" aria-hidden="true"></i>
        </span>
      </button>
    </div>
    <div class="dropdown-menu" role="menu">
      <div class="dropdown-content">
        <div class="dropdown-item">
        <a href="/finances/user/{{object.pk}}/reports" class="dropdown-item">
          Reports
        </a>
        </div>
        <div class="dropdown-item">
        <a href="/finances/user/{{object.pk}}/monthly_budgets" class="dropdown-item">
          Monthly Budgets
        </a>
        </div>
        <div class="dropdown-item">
        <a href="/finances/user/{{object.pk}}/accounts" class="dropdown-item">
          Accounts
        </a>
        </div>
        <div class="dropdown-item">
        <a href="/finances/user/{{object.pk}}/incomes" class="dropdown-item">
          Incomes
        </a>
        </div>
        <div class="dropdown-item">
        <a href="/finances/user/{{object.pk}}/expenses" class="dropdown-item">
          Expenses
        </a>
        </div>
      </div>
    </div>
</nav>
{% if report_type == 'month' %}
<nav class="level">
  <div class="level-item has-text-centered">
    <p class="title"> {{object.name}}'s Report for {{month}}, {{year}}</p>
  </div>
</nav>
{% endif %}
{% if report_type == 'year' %}
<nav class="level">
  <div class="level-item has-text-centered">
    <p class="title"> {{object.name}}'s Report for {{year}}</p>
  </div>
</nav>
{% endif %}

{% if report_type == 'month' %}
<nav class="level">
  <div class="tile is-ancestor">
    <div class="tile">
      <table class="table">
        <thead>
        <tr>
          <th>Budget Group</th>
          <th>Budgeted</th>
          <th>Spent</th>
          <th>Left Over</th>
        </tr>
        </thead>
        <tbody>
        <tr>
          <td>Statutory</td>
          <td>{{monthly_budget.statutory}}</td>
          <td>{{tot_statutory_expenses}}</td>
          <td>{{leftover_statutory}}</td>
        </tr>
        <tr>
          <td>Mandatory</td>
          <td>{{monthly_budget.mandatory}}</td>
          <td>{{tot_mandatory_expenses}}</td>
          <td>{{leftover_mandatory}}</td>
        </tr>
        <tr>
          <td>Mortgage</td>
          <td>{{monthly_budget.mortgage}}</td>
          <td>{{tot_mortgage_expenses}}</td>
          <td>{{leftover_mortgage}}</td>
        </tr>
        <tr>
          <td>Debts, Goals, Retirement</td>
          <td>{{monthly_budget.debts_goals_retirement}}</td>
          <td>{{tot_debts_goals_retirement_expenses}}</td>
          <td>{{leftover_dgr}}</td>
        </tr>
        <tr>
          <td>Discretionary</td>
          <td>{{monthly_budget.discretionary}}</td>
          <td>{{tot_discretionary_expenses}}</td>
          <td>{{leftover_disc}}</td>
        </tr>
        </tbody>
      </table>
    </div>
    <div class="tile">
      <canvas id="barchart_budget_spent"></canvas>
    </div>
  </div>
</nav>

{% endif %}

<nav class="level">
  <div class="tile is-ancestor">
    <div class="tile">
      <canvas id="piechart_budget"></canvas>
    </div>
    <div class="tile">
      <canvas id="piechart_actual"></canvas>
    </div>
  </div>
</nav>

<div class="columns is-centered">
  <div class="column">
    <canvas id="barchart_by_category"></canvas>
  </div>
  <div class="column">
    <canvas id="barchart_by_description"></canvas>
  </div>
  <div class="column">
    <canvas id="barchart_by_location"></canvas>
  </div>
</div>

<nav class="level is-mobile">
  <div class="tile is-ancestor">
    <div class="tile">
      <canvas id="linechart_cumulativeexp"></canvas>
    </div>
    <div class="tile">
      <canvas id="linechart_cumulativeinc"></canvas>
    </div>
  </div>
</nav>
<!--TODO: Chart of cumulative net for month-->
{% endblock %}

{% block jsstuff %}
  {% if month %}
  <script>
  const ctx = document.getElementById('linechart_cumulativeexp');
  var exp_cum_chart = new Chart(ctx, {
      type: 'line',
    });
  const ctx2 = document.getElementById('piechart_budget');
  var budget_pie_chart = new Chart(ctx2, {
    type: 'pie',
    });
  const ctx3 = document.getElementById('piechart_actual');
  var actual_pie_chart = new Chart(ctx3, {
    type: 'pie',
    });
  const ctx4 = document.getElementById('barchart_budget_spent');
  var budget_vs_spent_chart = new Chart(ctx4, {
    type: 'bar',
    });
  var ctx5 = document.getElementById('barchart_by_category');
  var top_category_chart = new Chart(ctx5, {
    type: 'bar',
    });
  var ctx6 = document.getElementById('barchart_by_description');
  var top_description_chart = new Chart(ctx6, {
    type: 'bar',
    });
  var ctx7 = document.getElementById('barchart_by_location');
  var top_location_chart = new Chart(ctx7, {
    type: 'bar',
    });
  const ctx8 = document.getElementById('linechart_cumulativeinc');
  var income_cum_chart = new Chart(ctx8, {
    type: 'line',
    });

  $(document).ready(function () {
      // create an AJAX JSON request for monthly budget and actual
      url = "{% url 'plot_monthlybudget_for_user' object.pk month year %}";
      $.getJSON(url, function(result) {
        budget_pie_chart.data = result.data;
        budget_pie_chart.options = result.config.options;
        budget_pie_chart.update();
        });
      url = "{% url 'plot_expenses_by_budget_group' object.pk month year %}";
      $.getJSON(url, function(result) {
        actual_pie_chart.data = result.data;
        actual_pie_chart.options = result.config.options;
        actual_pie_chart.update();
        });
      url = "{% url 'plot_bar_budget_vs_spent_month_year' object.pk month year %}";
      $.getJSON(url, function(result) {
        budget_vs_spent_chart.options = result.options;
        budget_vs_spent_chart.data = result.data;
        budget_vs_spent_chart.update();
        });
      url = "{% url 'plot_top5_by_category' object.pk month year %}";
      $.getJSON(url, function(result) {
          top_category_chart.options = result.options;
          top_category_chart.data = result.data;
          top_category_chart.update();
          });
      url = "{% url 'plot_top5_by_description' object.pk month year %}";
      $.getJSON(url, function(result) {
          top_description_chart.options = result.options;
          top_description_chart.data = result.data;
          top_description_chart.update();
          });
      url = "{% url 'plot_top5_by_location' object.pk month year %}";
      $.getJSON(url, function(result) {
          top_location_chart.options = result.options;
          top_location_chart.data = result.data;
          top_location_chart.update();
          });
      url = "{% url 'plot_expenses_cumulative_month_year' object.pk month year %}";
      $.getJSON(url, function(result) {
          exp_cum_chart.data = result.data;
          exp_cum_chart.options = result.config.options;
          exp_cum_chart.update();
          });
      url =   "{% url 'plot_incomes_cumulative_month_year' object.pk month year %}";
      $.getJSON(url, function(result) {
          income_cum_chart.data = result.data;
          income_cum_chart.options = result.config.options;
          income_cum_chart.update();
          });
      });
  </script>
  {% endif %}
{% endblock %}
